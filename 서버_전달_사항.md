# 서버 전달 사항

## 알림 시스템 리팩토링 (1차 + 2차 작업 + 서버 협의 반영)

### 작업 요약
클라이언트 측에서 알림 시스템을 Provider 기반으로 재설계하고, FCM(모바일)과 WebSocket(웹)을 통합하는 아키텍처로 변경했습니다.

---

## 협의 완료 사항 (프론트 수정 완료)

### 1. WebSocket 인증 방식 ✅
**쿼리 파라미터 방식으로 프론트 수정 완료**

```
ws://{서버주소}/ws?token={jwt_token}
wss://{서버주소}/ws?token={jwt_token}
```

### 2. FCM API 경로 ✅
**기존 서버 경로 사용 확인 완료**

```
POST /api/user/fcm-token
```

### 3. Ping/Pong ✅
**프론트에서 pong 메시지 무시 처리 완료**

```
클라이언트 → {"type": "ping"}
서버 → {"type": "pong", "timestamp": "..."}  // 프론트에서 무시
```

### 4. related_id 처리 ✅
**프론트에서 data 내부에서 추출하도록 구현 완료**

- `data.post_id`
- `data.application_id`
- `data.column_id`
- `data.user_id`

---

## 서버 추가 요청 사항

### 1. WebSocket 메시지에 notification_id 추가 요청

현재 서버 형식:
```json
{
  "type": "알림타입",
  "title": "알림 제목",
  "body": "알림 내용",
  "data": {},
  "timestamp": 1704614400
}
```

**요청: `notification_id` 필드 추가**
```json
{
  "type": "알림타입",
  "notification_id": 123,  // ← 추가 요청 (읽음 처리에 필요)
  "title": "알림 제목",
  "body": "알림 내용",
  "data": {},
  "timestamp": 1704614400
}
```

> `notification_id`가 없으면 프론트에서 `timestamp`를 ID로 사용합니다.
> 하지만 읽음 처리 API 호출 시 정확한 ID가 필요합니다.

---

### 2. 알림 타입 추가 요청

현재 서버 지원 타입:
- `new_user_registration`
- `admin_alert`
- `hospital_alert`
- `donation_post_approved`
- `broadcast`
- `general`

**추가 요청 타입:**

| 타입 | 설명 | 대상 |
|------|------|------|
| `new_post_approval` | 게시글 승인 요청 | 관리자 |
| `donation_post_rejected` | 게시글 거절됨 | 병원 |
| `column_approval` | 컬럼 승인 요청 | 관리자 |
| `column_approved` | 컬럼 승인됨 | 병원 |
| `column_rejected` | 컬럼 거절됨 | 병원 |
| `donation_application` | 헌혈 신청 접수 | 병원 |
| `donation_application_approved` | 헌혈 신청 승인됨 | 사용자 |
| `donation_application_rejected` | 헌혈 신청 거절됨 | 사용자 |

---

## 현재 프론트 상태

| 항목 | 상태 |
|------|------|
| WebSocket 쿼리 파라미터 인증 | ✅ 완료 |
| FCM API `/api/user/fcm-token` | ✅ 완료 |
| pong 메시지 무시 | ✅ 완료 |
| related_id data에서 추출 | ✅ 완료 |
| notification_id 없으면 timestamp 사용 | ✅ 완료 |

---

## 추후 작업 예정 (3차)

다음 작업이 진행되면 추가로 전달드리겠습니다:

1. **unified_notification_page.dart 리팩토링**
   - Provider 사용으로 변경
   - 서버 영향 없음 (예정)

2. **기존 서비스 파일 정리**
   - 코드 정리 작업
   - 서버 영향 없음 (예정)

---

## [긴급] CORS 설정 요청

### 문제 상황
- **Android 앱**: 정상 동작 ✅
- **웹 브라우저**: API 호출 불가 ❌

현재 웹에서는 CORS 문제로 인해 **임시로 목(Mock) 데이터**를 사용하고 있습니다.
웹에서도 실제 서버 데이터를 사용하려면 CORS 설정이 필요합니다.

### 요청 사항

서버에서 다음 CORS 헤더 설정이 필요합니다:

```
Access-Control-Allow-Origin: *
또는
Access-Control-Allow-Origin: http://localhost:포트번호

Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS
Access-Control-Allow-Headers: Content-Type, Authorization
Access-Control-Allow-Credentials: true (필요시)
```

### FastAPI 예시 (Python)
```python
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # 또는 특정 도메인 리스트
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

### 확인 방법
CORS 설정 후 알려주시면, 프론트에서 목 데이터 제거하고 실제 API 연동하겠습니다.

---

## 요약

**프론트 수정 완료:**
- WebSocket 인증 방식 (쿼리 파라미터)
- pong 메시지 무시
- related_id를 data에서 추출

**서버 추가 요청:**
1. WebSocket 메시지에 `notification_id` 필드 추가
2. 알림 타입 8개 추가
3. **[긴급] CORS 설정** (웹 브라우저 지원용)
